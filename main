#!/usr/bin/env bash

set -euo pipefail

flags=(
    "-ffast-math"
    "-fno-exceptions"
    "-fno-math-errno"
    "-fno-rtti"
    "-fno-unwind-tables"
    "-fshort-enums"
    "-g"
    "-march=native"
    "-O3"
    "-pthread"
    "-std=gnu++11"
    "-Werror"
    "-Weverything"
    "-Wno-c++98-compat"
    "-Wno-c++98-compat-pedantic"
    "-Wno-c99-extensions"
    "-Wno-old-style-cast"
    "-Wno-padded"
    "-Wno-reserved-id-macro"
)

now () {
    date +%s.%N
}

cppcheck --enable=all "$WD/src" | sed 's/\/.*\/\(.*\) \.\.\./\1/g'
clang-format -i -verbose "$WD/src"/* 2>&1 | sed 's/\/.*\///g'

(
    start=$(now)
    clang++ -o "$WD/bin/main" "${flags[@]}" "$WD/src/main.cpp"
    end=$(now)
    python3 -c "print(\"Compiled! ({:.3f}s)\n\".format(${end} - ${start}))"
)

"$WD/bin/main" "$WD/out/main.bmp"
